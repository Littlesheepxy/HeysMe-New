'use client';

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { 
  Play, 
  RefreshCw, 
  ExternalLink, 
  Download,
  Monitor,
  Smartphone,
  Loader2,
  AlertCircle,
  CheckCircle2,
  Sparkles,
  Terminal,
  Code
} from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import { cn } from '@/lib/utils';
import { WebContainerService, type ContainerStatus } from '@/lib/services/webcontainer-service';
import { type CodeFile } from '@/lib/agents/coding/types';
import { StagewiseToolbar } from './StagewiseToolbar';
import { useTheme } from '@/contexts/theme-context';

type DeviceType = 'desktop' | 'mobile';
type EditMode = 'none' | 'text' | 'ai';

interface WebContainerPreviewProps {
  files: CodeFile[];
  projectName: string;
  description?: string;
  isLoading: boolean;
  previewUrl: string | null;
  enableWebContainer: boolean;
  onPreviewReady: (url: string) => void;
  onLoadingChange: (loading: boolean) => void;
  isEditMode?: boolean;
  onContentChange?: (field: string, value: string) => void;
  deviceType?: DeviceType;
  editMode?: EditMode;
}

export function WebContainerPreview({
  files,
  projectName,
  description,
  isLoading,
  previewUrl,
  enableWebContainer,
  onPreviewReady,
  onLoadingChange,
  isEditMode,
  onContentChange,
  deviceType = 'desktop',
  editMode = 'none'
}: WebContainerPreviewProps) {
  
  // ============== Áä∂ÊÄÅÁÆ°ÁêÜ ==============
  const [containerStatus, setContainerStatus] = useState<ContainerStatus>('initializing');
  const [buildLogs, setBuildLogs] = useState<string[]>([]);
  const [showLogs, setShowLogs] = useState(false);
  const [refreshKey, setRefreshKey] = useState(0);
  const [webcontainerService, setWebcontainerService] = useState<WebContainerService | null>(null);
  const [isStarting, setIsStarting] = useState(false);
  const [packageJsonReady, setPackageJsonReady] = useState(false);
  const [otherFilesReady, setOtherFilesReady] = useState(false);
  
  const iframeRef = useRef<HTMLIFrameElement>(null);
  const packageJsonTimerRef = useRef<NodeJS.Timeout | null>(null);
  const otherFilesTimerRef = useRef<NodeJS.Timeout | null>(null);
  const { theme } = useTheme();

  // ============== ËÆæÂ§áÈÖçÁΩÆ ==============
  const deviceConfigs = {
    desktop: {
      width: '100%',
      height: '100%',
      label: 'Ê°åÈù¢È¢ÑËßà',
      icon: Monitor
    },
    mobile: {
      width: '375px',
      height: '667px',
      label: 'ÁßªÂä®È¢ÑËßà',
      icon: Smartphone
    }
  };

  // ============== Â∑•ÂÖ∑ÂáΩÊï∞ ==============
  const log = useCallback((message: string) => {
    setBuildLogs(prev => [...prev, message]);
  }, []);

  const generateMockPreviewUrl = useCallback(() => {
    const htmlFile = files.find(f => f.filename.endsWith('.html') || f.filename === 'index.html');
    const tsxFile = files.find(f => f.filename.endsWith('.tsx') && f.filename.includes('page'));
    const jsxFile = files.find(f => f.filename.endsWith('.jsx') && f.filename.includes('page'));
    
    if (htmlFile) {
      return `data:text/html;charset=utf-8,${encodeURIComponent(htmlFile.content)}`;
    }
    
    if (tsxFile || jsxFile) {
      const mockHtml = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${projectName}</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body { margin: 0; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
    ${files.find(f => f.filename.includes('globals.css') || f.filename.includes('index.css'))?.content || ''}
    ${files.find(f => f.filename.includes('tailwind') || f.filename.includes('style'))?.content || ''}
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    ${(tsxFile || jsxFile)?.content || ''}
  </script>
</body>
</html>`;
      return `data:text/html;charset=utf-8,${encodeURIComponent(mockHtml)}`;
    }
    
    return `data:text/html;charset=utf-8,${encodeURIComponent(`
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${projectName}</title>
  <style>
    body { margin: 0; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
    .container { max-width: 800px; margin: 0 auto; text-align: center; }
    .title { color: #333; margin-bottom: 20px; }
    .description { color: #666; line-height: 1.6; }
    .file-list { margin-top: 30px; text-align: left; }
    .file-item { padding: 10px; margin: 5px 0; background: #f5f5f5; border-radius: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">${projectName}</h1>
    ${description ? `<p class="description">${description}</p>` : ''}
    <div class="file-list">
      <h3>È°πÁõÆÊñá‰ª∂Ôºö</h3>
      ${files.map(f => `<div class="file-item">${f.filename}</div>`).join('')}
    </div>
  </div>
</body>
</html>
    `)}`;
  }, [files, projectName, description]);

  // ============== Ê†∏ÂøÉÈÄªËæëÂáΩÊï∞ ==============
  const startProgressiveWebContainer = useCallback(async () => {
    if (!webcontainerService || isStarting) return;

    setIsStarting(true);
    try {
      await webcontainerService.progressiveStart(files);
      log('‚úÖ Ê∏êËøõÂºèÂêØÂä®ÊàêÂäü');
    } catch (error) {
      log(`‚ùå Ê∏êËøõÂºèÂêØÂä®Â§±Ë¥•: ${error}`);
      setContainerStatus('error');
      // ÈôçÁ∫ßÂà∞Ê®°ÊãüÈ¢ÑËßà
      const mockUrl = generateMockPreviewUrl();
      onPreviewReady(mockUrl);
    } finally {
      setIsStarting(false);
    }
  }, [webcontainerService, isStarting, files, log, generateMockPreviewUrl, onPreviewReady]);

  const mountPackageJsonOnly = useCallback(async () => {
    if (!webcontainerService || isStarting) return;

    const packageJsonFile = files.find(f => f.filename === 'package.json');
    if (!packageJsonFile) return;

    try {
      setIsStarting(true);
      await webcontainerService.mountPackageJson(packageJsonFile);
      log('‚úÖ package.jsonÊåÇËΩΩÂÆåÊàêÔºå‰æùËµñÂÆâË£Ö‰∏≠...');
    } catch (error) {
      log(`‚ùå package.jsonÊåÇËΩΩÂ§±Ë¥•: ${error}`);
      setContainerStatus('error');
    } finally {
      setIsStarting(false);
    }
  }, [webcontainerService, isStarting, files, log]);

  const mountOtherFilesAndStart = useCallback(async () => {
    if (!webcontainerService || isStarting) return;

    const otherFiles = files.filter(f => f.filename !== 'package.json');
    if (otherFiles.length === 0) return;

    try {
      setIsStarting(true);
      await webcontainerService.mountOtherFilesAndStart(otherFiles);
      log('‚úÖ ÂÖ∂‰ªñÊñá‰ª∂ÊåÇËΩΩÂÆåÊàêÔºåÊúçÂä°Âô®ÂêØÂä®‰∏≠...');
    } catch (error) {
      log(`‚ùå ÂÖ∂‰ªñÊñá‰ª∂ÊåÇËΩΩÂ§±Ë¥•: ${error}`);
      setContainerStatus('error');
    } finally {
      setIsStarting(false);
    }
  }, [webcontainerService, isStarting, files, log]);

  const refreshPreview = useCallback(() => {
    // üîÑ ÊâãÂä®Âà∑Êñ∞ÂºÄÂßã
    log('üîÑ ÊâãÂä®Âà∑Êñ∞ÂºÄÂßã...');
    setRefreshKey(prev => prev + 1);
    setIsStarting(false);
    setContainerStatus('initializing');
    setPackageJsonReady(false);
    setOtherFilesReady(false);
    
    // üîß Â¶ÇÊûúÊúâWebContainerÊúçÂä°Ôºå‰∏çÈîÄÊØÅÂÆû‰æãÔºåËÄåÊòØÈáçÁΩÆÈ°πÁõÆÁä∂ÊÄÅ
    if (webcontainerService) {
      log('üîÑ Âà∑Êñ∞È¢ÑËßàÔºåÈáçÁΩÆÈ°πÁõÆÁä∂ÊÄÅ...');
      
             // ÈáçÁΩÆÈ°πÁõÆÁä∂ÊÄÅÔºå‰ΩÜ‰øùÁïôWebContainerÂÆû‰æã
       webcontainerService.resetProjectState().then(() => {
         log('üßπ È°πÁõÆÁä∂ÊÄÅÂ∑≤ÈáçÁΩÆ');
        
        // Â¶ÇÊûúÂêØÁî®WebContainer‰∏îÊúâÊñá‰ª∂ÔºåÈáçÊñ∞ÂêØÂä®È°πÁõÆ
        if (enableWebContainer && files.length > 0) {
          log('üöÄ ÂºÄÂßãÈáçÊñ∞ÈÉ®ÁΩ≤È°πÁõÆ...');
          
          // ‰ΩøÁî®Ê∏êËøõÂºèÂêØÂä®
          webcontainerService.progressiveStart(files)
            .then(() => {
              log('‚úÖ È°πÁõÆÈáçÊñ∞ÈÉ®ÁΩ≤ÊàêÂäü');
            })
            .catch((error) => {
              log(`‚ùå È°πÁõÆÈáçÊñ∞ÈÉ®ÁΩ≤Â§±Ë¥•: ${error.message}`);
              setContainerStatus('error');
              
              // Â¶ÇÊûúÊòØWebContainerÂÆû‰æãÈóÆÈ¢òÔºåÂ∞ùËØïÈáçÊñ∞ÂàõÂª∫ÊúçÂä°
              if (error.message.includes('Only a single WebContainer instance can be booted')) {
                log('üîÑ Â∞ùËØïÈáçÊñ∞ÂàõÂª∫WebContainerÊúçÂä°...');
                recreateService();
              } else {
                // ÂÖ∂‰ªñÈîôËØØÔºåÈôçÁ∫ßÂà∞Ê®°ÊãüÈ¢ÑËßà
                const mockUrl = generateMockPreviewUrl();
                onPreviewReady(mockUrl);
              }
            });
        }
      }).catch(error => {
        log(`‚ùå ÁªàÊ≠¢ËøõÁ®ãÂ§±Ë¥•: ${error.message}`);
        
        // Â¶ÇÊûúÁªàÊ≠¢ËøõÁ®ãÈÉΩÂ§±Ë¥•ÔºåËØ¥ÊòéÂÆû‰æãÂèØËÉΩÊúâÈóÆÈ¢òÔºåÈáçÊñ∞ÂàõÂª∫ÊúçÂä°
        recreateService();
      });
    } else {
      // Ê≤°ÊúâWebContainerÊúçÂä°ÔºåÂàõÂª∫Êñ∞ÊúçÂä°
      recreateService();
    }

    // ÈáçÊñ∞ÂàõÂª∫ÊúçÂä°ÁöÑÂáΩÊï∞
    function recreateService() {
      log('üîß ÈáçÊñ∞ÂàõÂª∫WebContainerÊúçÂä°...');
      
      const service = new WebContainerService({
        clientId: 'wc_api_littlesheepxy_33595e6cd89a5813663cd3f70b26e12d',
        workdirName: projectName.toLowerCase().replace(/\s+/g, '-')
      });

      // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
      service.onServerReady((port: number, url: string) => {
        log(`üåê ÊúçÂä°Âô®Â∞±Áª™: ${url}`);
        setRefreshKey(prev => prev + 1);
        onPreviewReady(url);
        setContainerStatus('running');
        onLoadingChange(false);
        setIsStarting(false);
      });

      service.onStatusChange((status) => {
        setContainerStatus(status);
        log(`üìä Áä∂ÊÄÅÂèòÂåñ: ${status}`);
      });

             service.onLog((logMessage) => {
         log(logMessage);
       });

       service.onDependenciesReady(() => {
         log('üéâ ‰æùËµñÂÆâË£ÖÂÆåÊàêÔºåÂáÜÂ§á‰∏ã‰∏ÄÊ≠•...');
         // Âº∫Âà∂Ëß¶ÂèëReactÁä∂ÊÄÅÊõ¥Êñ∞
         setContainerStatus('ready');
         
         // Ê£ÄÊü•ÂΩìÂâçÁä∂ÊÄÅ
         const mountStatus = service.getMountStatus();
         const hasOtherFiles = files.some(f => f.filename !== 'package.json');
         log(`üîç ÂΩìÂâçÁä∂ÊÄÅÊ£ÄÊü•: packageJsonMounted=${mountStatus.packageJsonMounted}, dependenciesInstalled=${mountStatus.dependenciesInstalled}, hasOtherFiles=${hasOtherFiles}, otherFilesReady=${otherFilesReady}, isStarting=${isStarting}`);
         
         // Á´ãÂç≥Ëß¶ÂèëÂÖ∂‰ªñÊñá‰ª∂ÊåÇËΩΩÊ£ÄÊü•ÔºåËÄå‰∏çÊòØÂª∂Ëøü
         if (!otherFilesReady) {
           log('üîÑ ËÆæÁΩÆotherFilesReady=true');
           setOtherFilesReady(true);
         }
         
         // Â¶ÇÊûúÊù°‰ª∂Êª°Ë∂≥ÔºåÁõ¥Êé•Ëß¶Âèë‰∏ã‰∏ÄÊ≠•
         if (mountStatus.packageJsonMounted && mountStatus.dependenciesInstalled && !isStarting) {
           if (hasOtherFiles) {
             log('üöÄ Á´ãÂç≥ÂºÄÂßãÊåÇËΩΩÂÖ∂‰ªñÊñá‰ª∂Âπ∂ÂêØÂä®ÊúçÂä°Âô®...');
             setIsStarting(true);
             mountOtherFilesAndStart().finally(() => {
               setIsStarting(false);
             });
           } else {
             log('üöÄ Á´ãÂç≥ÂºÄÂßãÂêØÂä®ÂºÄÂèëÊúçÂä°Âô®...');
             setIsStarting(true);
             startProgressiveWebContainer().finally(() => {
               setIsStarting(false);
             });
           }
         }
       });

       setWebcontainerService(service);
       
       // Â¶ÇÊûúÂêØÁî®WebContainer‰∏îÊúâÊñá‰ª∂ÔºåÁ´ãÂç≥ÂºÄÂßãÈ¢ÑÂêØÂä®
       if (enableWebContainer && files.length > 0) {
        service.prestart()
          .then(() => {
            log('‚úÖ WebContainerÈ¢ÑÂêØÂä®ÂÆåÊàê');
          })
          .catch((error) => {
            log(`‚ùå WebContainerÈ¢ÑÂêØÂä®Â§±Ë¥•: ${error.message}`);
            setContainerStatus('error');
            // ÈôçÁ∫ßÂà∞Ê®°ÊãüÈ¢ÑËßà
            const mockUrl = generateMockPreviewUrl();
            onPreviewReady(mockUrl);
          });
      } else {
        // Ê≤°ÊúâÂêØÁî®WebContainerÔºåÁõ¥Êé•‰ΩøÁî®Ê®°ÊãüÈ¢ÑËßà
        const mockUrl = generateMockPreviewUrl();
        onPreviewReady(mockUrl);
        log('üéØ ‰ΩøÁî®Ê®°ÊãüÈ¢ÑËßà');
      }
    }
  }, [webcontainerService, onPreviewReady, enableWebContainer, files.length, generateMockPreviewUrl, projectName, log, onLoadingChange]);

  // ============== ÁîüÂëΩÂë®ÊúüÁÆ°ÁêÜ ==============
  
  // 1. ÁªÑ‰ª∂ÂàùÂßãÂåñ - Âè™Âú®ÁúüÊ≠£ÈúÄË¶ÅÊó∂Ê∏ÖÁêÜ
  useEffect(() => {
    // ‰∏çË¶ÅÂú®ÊØèÊ¨°ÁªÑ‰ª∂Ê∏≤ÊüìÊó∂ÈÉΩÊ∏ÖÁêÜÔºåÂè™Âú®ÁªÑ‰ª∂Âç∏ËΩΩÊó∂Ê∏ÖÁêÜ
    return () => {
      if (webcontainerService) {
        webcontainerService.destroy().catch(console.warn);
      }
    };
  }, [webcontainerService]);

  // 2. Êñá‰ª∂ÂèòÂåñÂ§ÑÁêÜ - Ê∏êËøõÂºèÊ£ÄÊµãÊñá‰ª∂Âà∞Ëææ
  useEffect(() => {
    // Ê∏ÖÁêÜÂÆöÊó∂Âô®
    if (packageJsonTimerRef.current) {
      clearTimeout(packageJsonTimerRef.current);
    }
    if (otherFilesTimerRef.current) {
      clearTimeout(otherFilesTimerRef.current);
    }

    if (files.length > 0) {
      const hasPackageJson = files.some(f => f.filename === 'package.json');
      const hasOtherFiles = files.some(f => f.filename !== 'package.json');

      // Ê£ÄÊµãpackage.json
      if (hasPackageJson && !packageJsonReady) {
        log('üì¶ Ê£ÄÊµãÂà∞package.jsonÔºåÂáÜÂ§áÊåÇËΩΩ...');
        packageJsonTimerRef.current = setTimeout(() => {
          setPackageJsonReady(true);
        }, 1000); // package.json Âø´ÈÄüÂ§ÑÁêÜ
      }

      // Ê£ÄÊµãÂÖ∂‰ªñÊñá‰ª∂
      if (hasOtherFiles && !otherFilesReady) {
        // Ê£ÄÊü•ÂÖ≥ÈîÆÊñá‰ª∂ÂÆåÊï¥ÊÄß
      const hasEntryFile = files.some(f => 
        f.filename.includes('main.tsx') || 
        f.filename.includes('index.tsx') || 
        f.filename.includes('App.tsx') ||
        f.filename.includes('page.tsx')
      );
      const hasIndexHtml = files.some(f => f.filename === 'index.html');
        
        // Ê†πÊçÆÊñá‰ª∂ÂÆåÊï¥ÊÄßË∞ÉÊï¥Á≠âÂæÖÊó∂Èó¥
        const waitTime = (hasEntryFile || hasIndexHtml) ? 2000 : 4000;
        
        log(`üìÅ Ê£ÄÊµãÂà∞ ${files.length} ‰∏™Êñá‰ª∂ÔºåÁ≠âÂæÖÊñá‰ª∂Á®≥ÂÆö...`);
        otherFilesTimerRef.current = setTimeout(() => {
          setOtherFilesReady(true);
        }, waitTime);
      }
    }

    return () => {
      if (packageJsonTimerRef.current) {
        clearTimeout(packageJsonTimerRef.current);
      }
      if (otherFilesTimerRef.current) {
        clearTimeout(otherFilesTimerRef.current);
      }
    };
  }, [files, packageJsonReady, otherFilesReady, log]);

  // 3. WebContainerÊúçÂä°ÂàùÂßãÂåñ
  useEffect(() => {
    if (enableWebContainer && !webcontainerService) {
      log('üöÄ ÂàùÂßãÂåñWebContainerÊúçÂä°...');
      
      const service = new WebContainerService({
        clientId: 'wc_api_littlesheepxy_33595e6cd89a5813663cd3f70b26e12d',
        workdirName: projectName.toLowerCase().replace(/\s+/g, '-')
      });

      // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
      service.onServerReady((port: number, url: string) => {
        log(`üåê ÊúçÂä°Âô®Â∞±Áª™: ${url}`);
        setRefreshKey(prev => prev + 1);
        onPreviewReady(url);
        setContainerStatus('running');
        onLoadingChange(false);
        setIsStarting(false);
      });

      service.onStatusChange((status) => {
        setContainerStatus(status);
        log(`üìä Áä∂ÊÄÅÂèòÂåñ: ${status}`);
      });

      service.onLog((logMessage) => {
        log(logMessage);
      });

      service.onDependenciesReady(() => {
        log('üéâ ‰æùËµñÂÆâË£ÖÂÆåÊàêÔºåÂáÜÂ§á‰∏ã‰∏ÄÊ≠•...');
        // Âº∫Âà∂Ëß¶ÂèëReactÁä∂ÊÄÅÊõ¥Êñ∞
        setContainerStatus('ready');
        
        // Ê£ÄÊü•ÂΩìÂâçÁä∂ÊÄÅ
        const mountStatus = service.getMountStatus();
        const hasOtherFiles = files.some(f => f.filename !== 'package.json');
        log(`üîç ÂΩìÂâçÁä∂ÊÄÅÊ£ÄÊü•: packageJsonMounted=${mountStatus.packageJsonMounted}, dependenciesInstalled=${mountStatus.dependenciesInstalled}, hasOtherFiles=${hasOtherFiles}, otherFilesReady=${otherFilesReady}, isStarting=${isStarting}`);
        
        // Á´ãÂç≥Ëß¶ÂèëÂÖ∂‰ªñÊñá‰ª∂ÊåÇËΩΩÊ£ÄÊü•ÔºåËÄå‰∏çÊòØÂª∂Ëøü
        if (!otherFilesReady) {
          log('üîÑ ËÆæÁΩÆotherFilesReady=true');
          setOtherFilesReady(true);
        }
        
        // Â¶ÇÊûúÊù°‰ª∂Êª°Ë∂≥ÔºåÁõ¥Êé•Ëß¶Âèë‰∏ã‰∏ÄÊ≠•
        if (mountStatus.packageJsonMounted && mountStatus.dependenciesInstalled && !isStarting) {
          if (hasOtherFiles) {
            log('üöÄ Á´ãÂç≥ÂºÄÂßãÊåÇËΩΩÂÖ∂‰ªñÊñá‰ª∂Âπ∂ÂêØÂä®ÊúçÂä°Âô®...');
            setIsStarting(true);
            mountOtherFilesAndStart().finally(() => {
              setIsStarting(false);
            });
          } else {
            log('üöÄ Á´ãÂç≥ÂºÄÂßãÂêØÂä®ÂºÄÂèëÊúçÂä°Âô®...');
            setIsStarting(true);
            startProgressiveWebContainer().finally(() => {
              setIsStarting(false);
            });
          }
        }
      });

      setWebcontainerService(service);
      
      // ÂºÄÂßãÈ¢ÑÂêØÂä®
      service.prestart()
        .then(() => {
          log('‚úÖ WebContainerÈ¢ÑÂêØÂä®ÂÆåÊàê');
        })
        .catch((error) => {
          log(`‚ùå WebContainerÈ¢ÑÂêØÂä®Â§±Ë¥•: ${error.message}`);
        setContainerStatus('error');
      });
    }
  }, [enableWebContainer, projectName, webcontainerService, log, onPreviewReady, onLoadingChange]);

  // 4. Ê∏êËøõÂºèÊåÇËΩΩ - package.json ‰ºòÂÖàÂ§ÑÁêÜÔºàÂ¢ûÂä†ÂéªÈáçÔºâ
  useEffect(() => {
    if (webcontainerService && packageJsonReady && !isStarting) {
      const hasPackageJson = files.some(f => f.filename === 'package.json');
      if (hasPackageJson) {
        const mountStatus = webcontainerService.getMountStatus();
        if (!mountStatus.packageJsonMounted) {
          log('üì¶ ÂºÄÂßãÊåÇËΩΩpackage.jsonÂπ∂ÂÆâË£Ö‰æùËµñ...');
          setIsStarting(true); // Èò≤Ê≠¢ÈáçÂ§çÊâßË°å
          mountPackageJsonOnly().finally(() => {
            setIsStarting(false);
          });
        }
      }
    }
  }, [webcontainerService, packageJsonReady, isStarting, files, log, mountPackageJsonOnly]);

  // 5. ÂÖ∂‰ªñÊñá‰ª∂ÊåÇËΩΩÂíåÊúçÂä°Âô®ÂêØÂä®
  useEffect(() => {
    if (webcontainerService && otherFilesReady && !isStarting) {
      const mountStatus = webcontainerService.getMountStatus();
      const hasOtherFiles = files.some(f => f.filename !== 'package.json');
      
      if (hasOtherFiles && mountStatus.packageJsonMounted && mountStatus.dependenciesInstalled) {
        log('üìÅ ÂºÄÂßãÊåÇËΩΩÂÖ∂‰ªñÊñá‰ª∂Âπ∂ÂêØÂä®ÊúçÂä°Âô®...');
        setIsStarting(true);
        mountOtherFilesAndStart().finally(() => {
          setIsStarting(false);
        });
      } else if (!hasOtherFiles && mountStatus.packageJsonMounted && mountStatus.dependenciesInstalled) {
        // Âè™Êúâpackage.jsonÁöÑÊÉÖÂÜµÔºåÁõ¥Êé•ÂêØÂä®
        log('üöÄ ÂºÄÂßãÂêØÂä®ÂºÄÂèëÊúçÂä°Âô®...');
        setIsStarting(true);
        startProgressiveWebContainer().finally(() => {
          setIsStarting(false);
        });
      }
    }
  }, [webcontainerService, otherFilesReady, isStarting, files, log, mountOtherFilesAndStart, startProgressiveWebContainer]);

  // 6. Ê®°ÊãüÈ¢ÑËßàÁîüÊàê - Á°Æ‰øùÂßãÁªàÊúâÈ¢ÑËßàÂÜÖÂÆπ
  useEffect(() => {
    if (files.length > 0 && !previewUrl) {
      const mockUrl = generateMockPreviewUrl();
      onPreviewReady(mockUrl);
      log('üéØ ÁîüÊàêÊ®°ÊãüÈ¢ÑËßà');
    }
  }, [files.length, previewUrl, onPreviewReady, generateMockPreviewUrl, log]);

  // 7. ‰∏ªÈ¢òÂèòÂåñÂ§ÑÁêÜ
  useEffect(() => {
    if (files.length > 0 && previewUrl && previewUrl.includes('data:')) {
      // Âè™Âú®Ê®°ÊãüÈ¢ÑËßàÊó∂ÈáçÊñ∞ÁîüÊàê
      const mockUrl = generateMockPreviewUrl();
      onPreviewReady(mockUrl);
      setRefreshKey(prev => prev + 1);
    }
  }, [theme, files.length, previewUrl, onPreviewReady, generateMockPreviewUrl]);

  // 8. È°µÈù¢ÂèØËßÅÊÄßÂ§ÑÁêÜ
  useEffect(() => {
    const handleVisibilityChange = () => {
      if (!document.hidden && webcontainerService && containerStatus === 'error') {
        setTimeout(() => {
          if ((packageJsonReady || otherFilesReady) && !isStarting) {
            startProgressiveWebContainer();
          }
        }, 1000);
      }
    };

    document.addEventListener('visibilitychange', handleVisibilityChange);
    return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
  }, [webcontainerService, containerStatus, packageJsonReady, otherFilesReady, isStarting, startProgressiveWebContainer]);

  // 9. ÁªÑ‰ª∂Ê∏ÖÁêÜ
  useEffect(() => {
    return () => {
      if (webcontainerService) {
        webcontainerService.destroy().catch(console.error);
      }
    };
  }, []);

  // ============== ÂèØËßÜÂåñÁºñËæëÂ§ÑÁêÜ ==============
  const handleElementModificationRequest = useCallback(async (elementInfo: any, prompt: string) => {
    const visualEditMessage = `
üéØ **ÂèØËßÜÂåñÁºñËæëËØ∑Ê±Ç**

**ÈÄâ‰∏≠ÂÖÉÁ¥†Ôºö**
- Ê†áÁ≠æ: \`${elementInfo.tagName}\`
- ÈÄâÊã©Âô®: \`${elementInfo.selector}\`
- Á±ªÂêç: \`${elementInfo.className}\`
- ÊñáÊú¨ÂÜÖÂÆπ: "${elementInfo.textContent?.slice(0, 100)}${elementInfo.textContent?.length > 100 ? '...' : ''}"

**‰øÆÊîπÈúÄÊ±ÇÔºö**
${prompt}

**È°πÁõÆ‰∏ä‰∏ãÊñáÔºö**
- È°πÁõÆÂêçÁß∞: ${projectName}
- Ê°ÜÊû∂: React
- ÂΩìÂâçÊñá‰ª∂Êï∞: ${files.length}

ËØ∑Â∏ÆÊàë‰øÆÊîπ‰ª£Á†ÅÊù•ÂÆûÁé∞Ëøô‰∏™ÈúÄÊ±Ç„ÄÇ
    `.trim();

    if (onContentChange) {
      onContentChange('visual_edit_request', visualEditMessage);
    } else {
      window.parent.postMessage({
        type: 'VISUAL_EDIT_TO_CHAT',
        message: visualEditMessage,
        elementInfo,
        prompt
      }, '*');
    }
  }, [files.length, projectName, onContentChange]);
    
  // ============== Ê∏≤Êüì ==============
  return (
    <div className="flex flex-col h-full bg-white dark:bg-gray-900 overflow-hidden">
      {/* È°∂ÈÉ®Â∑•ÂÖ∑Ê†è */}
      <div className={`flex items-center justify-between px-4 py-2 border-b ${
        theme === 'light' 
          ? 'bg-gray-50 border-gray-200' 
          : 'bg-gray-800 border-gray-700'
      }`}>
        <div className="flex items-center gap-3">
          <StatusIndicator status={containerStatus} theme={theme} />
          <Badge variant="outline" className={`text-xs ${
            theme === 'light' 
              ? 'border-gray-300 text-gray-700' 
              : 'border-gray-600 text-gray-300'
          }`}>
            {deviceConfigs[deviceType].label}
          </Badge>
          <Badge 
            variant={previewUrl?.includes('localhost') || previewUrl?.includes('webcontainer-api.io') ? 'default' : 'secondary'} 
            className="text-xs"
          >
            {previewUrl?.includes('localhost') || previewUrl?.includes('webcontainer-api.io') ? 'WebContainer' : 'Ê®°ÊãüÈ¢ÑËßà'}
          </Badge>
        </div>
        
        <div className="flex items-center gap-1">
          <Button
            variant="outline"
            size="sm"
            onClick={() => setShowLogs(!showLogs)}
            className={`flex items-center gap-1 h-7 px-2 text-xs ${
              theme === 'light' 
                ? 'border-gray-300 text-gray-700 hover:bg-gray-100' 
                : 'border-gray-600 text-gray-300 hover:bg-gray-700'
            }`}
          >
            <Terminal className="w-3 h-3" />
            {showLogs ? 'ÈöêËóèÊó•Âøó' : 'ÊòæÁ§∫Êó•Âøó'}
          </Button>
          
          <Button
            variant="outline"
            size="sm"
            onClick={() => {
              setBuildLogs(['üîÑ ÊâãÂä®Âà∑Êñ∞ÂºÄÂßã...']);
              refreshPreview();
            }}
            disabled={isLoading}
            className={`flex items-center gap-1 h-7 px-2 text-xs transition-all duration-200 ${
              theme === 'light' 
                ? 'border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-emerald-300' 
                : 'border-gray-600 text-gray-300 hover:bg-gray-700 hover:border-emerald-500'
            }`}
          >
            <RefreshCw className={cn("w-3 h-3", (isLoading || isStarting) && "animate-spin")} />
            Âà∑Êñ∞
          </Button>
          
          {enableWebContainer && containerStatus === 'error' && (
            <Button
              variant="default"
              size="sm"
              onClick={startProgressiveWebContainer}
              disabled={isLoading || isStarting}
              className="flex items-center gap-1 h-7 px-2 text-xs text-white"
            >
              <Play className="w-3 h-3" />
              {isStarting ? 'ÂêØÂä®‰∏≠...' : 'ÈáçÊñ∞ÂêØÂä®'}
            </Button>
          )}
        </div>
      </div>

      <div className="flex-1 flex">
        {/* È¢ÑËßàÂå∫Âüü */}
        <div className="flex-1 flex flex-col">
          <div className={`flex-1 p-4 ${
            theme === 'light' 
              ? 'bg-gray-100' 
              : 'bg-gray-800'
          }`}>
            <div 
              className={`mx-auto rounded-lg shadow-lg overflow-hidden border ${
                theme === 'light' 
                  ? 'bg-white border-gray-200' 
                  : 'bg-gray-900 border-gray-700'
              }`}
              style={{
                width: deviceConfigs[deviceType].width,
                height: deviceConfigs[deviceType].height,
                maxWidth: '100%',
                maxHeight: '100%'
              }}
            >
              {previewUrl ? (
                <iframe
                  key={refreshKey}
                  ref={iframeRef}
                  src={previewUrl}
                  className="w-full h-full border-0"
                  title={`${projectName} È¢ÑËßà`}
                />
              ) : (
                <PreviewPlaceholder status={containerStatus} theme={theme} />
              )}
            </div>
          </div>
        </div>

        {/* Êó•ÂøóÈù¢Êùø */}
        <AnimatePresence>
          {showLogs && (
            <motion.div
              initial={{ width: 0, opacity: 0 }}
              animate={{ width: 350, opacity: 1 }}
              exit={{ width: 0, opacity: 0 }}
              className={`border-l text-green-400 font-mono text-xs overflow-hidden ${
                theme === 'light' 
                  ? 'bg-gray-900 border-gray-300' 
                  : 'bg-gray-950 border-gray-700'
              }`}
            >
              <div className={`p-3 border-b flex items-center justify-between ${
                theme === 'light' 
                  ? 'border-gray-700' 
                  : 'border-gray-600'
              }`}>
                <h4 className="font-semibold text-white">ÊûÑÂª∫Êó•Âøó</h4>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => setBuildLogs([])}
                  className={`text-gray-400 hover:text-white h-6 px-2 ${
                    theme === 'light' 
                      ? 'hover:bg-gray-800' 
                      : 'hover:bg-gray-700'
                  }`}
                >
                  Ê∏ÖÁ©∫
                </Button>
              </div>
              <div className="p-3 h-full overflow-y-auto max-h-96">
                {buildLogs.length === 0 ? (
                  <div className={`${
                    theme === 'light' 
                      ? 'text-gray-500' 
                      : 'text-gray-400'
                  }`}>ÊöÇÊó†Êó•Âøó</div>
                ) : (
                  buildLogs.map((log, index) => (
                    <div key={index} className="mb-1 break-words">
                      {log}
                    </div>
                  ))
                )}
              </div>
            </motion.div>
          )}
        </AnimatePresence>
      </div>

      {/* ÂèØËßÜÂåñÁºñËæëÂ∑•ÂÖ∑Ê†è */}
      {editMode === 'ai' && (
        <StagewiseToolbar
          iframeRef={iframeRef}
          onElementModificationRequest={handleElementModificationRequest}
          isEnabled={true}
          onToggle={() => {}}
        />
      )}
    </div>
  );
}

// ============== Â≠êÁªÑ‰ª∂ ==============

function StatusIndicator({ status, theme }: { status: ContainerStatus; theme: string }) {
  const statusConfig = {
    initializing: { color: 'bg-blue-400 animate-pulse', label: 'ÂàùÂßãÂåñ‰∏≠', icon: Loader2 },
    prestarting: { color: 'bg-purple-400 animate-pulse', label: 'È¢ÑÂêØÂä®‰∏≠', icon: Sparkles },
    installing: { color: 'bg-yellow-400 animate-pulse', label: 'ÂÆâË£Ö‰æùËµñ', icon: Loader2 },
    building: { color: 'bg-orange-400 animate-pulse', label: 'ÊûÑÂª∫‰∏≠', icon: Loader2 },
    ready: { color: 'bg-blue-600', label: 'ÂáÜÂ§áÂ∞±Áª™', icon: CheckCircle2 },
    running: { color: 'bg-green-400', label: 'ËøêË°å‰∏≠', icon: CheckCircle2 },
    error: { color: 'bg-red-400', label: 'ÈîôËØØ', icon: AlertCircle }
  };

  const config = statusConfig[status] || statusConfig.initializing;
  const Icon = config.icon;

  return (
    <div className="flex items-center gap-2">
      <div className={cn("w-3 h-3 rounded-full", config.color)} />
      <Icon className={`w-4 h-4 ${
        theme === 'light' 
          ? 'text-gray-600' 
          : 'text-gray-400'
      }`} />
      <span className={`text-sm ${
        theme === 'light' 
          ? 'text-gray-600' 
          : 'text-gray-400'
      }`}>{config.label}</span>
    </div>
  );
}

function PreviewPlaceholder({ status, theme }: { status: ContainerStatus; theme: string }) {
  const messages = {
    initializing: 'Ê≠£Âú®ÂàùÂßãÂåñWebContainer...',
    prestarting: 'Ê≠£Âú®È¢ÑÂêØÂä®WebContainer...',
    installing: 'Ê≠£Âú®ÂÆâË£ÖÈ°πÁõÆ‰æùËµñ...',
    building: 'Ê≠£Âú®ÊûÑÂª∫È°πÁõÆ...',
    ready: 'WebContainerÂáÜÂ§áÂ∞±Áª™...',
    running: 'Ê≠£Âú®Âä†ËΩΩÈ¢ÑËßà...',
    error: 'È¢ÑËßàÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•‰ª£Á†Å'
  };

  return (
    <div className={`h-full flex items-center justify-center ${
      theme === 'light' 
        ? 'bg-gray-50' 
        : 'bg-gray-800'
    }`}>
      <div className="text-center">
        <Sparkles className={`w-12 h-12 mx-auto mb-4 ${
          theme === 'light' 
            ? 'text-gray-400' 
            : 'text-gray-500'
        }`} />
        <p className={`${
          theme === 'light' 
            ? 'text-gray-600' 
            : 'text-gray-400'
        }`}>{messages[status] || messages.initializing}</p>
        {status === 'error' && (
          <p className={`text-sm mt-2 ${
            theme === 'light' 
              ? 'text-red-500' 
              : 'text-red-400'
          }`}>
            ËØ∑Ê£ÄÊü•ÊéßÂà∂Âè∞Êó•ÂøóËé∑ÂèñËØ¶ÁªÜ‰ø°ÊÅØ
          </p>
        )}
      </div>
    </div>
  );
}

export default WebContainerPreview; 