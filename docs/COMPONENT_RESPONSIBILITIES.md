# ğŸ¯ ç»„ä»¶èŒè´£åˆ†å·¥æ˜ç»†

## ğŸ“‹ **ChatInterface vs MessageBubble èŒè´£åˆ’åˆ†**

### ğŸ—ï¸ **ChatInterface èŒè´£èŒƒå›´**

#### ã€æ ¸å¿ƒèŒè´£ã€‘
1. **å…¨å±€çŠ¶æ€ç®¡ç†**
   - ä¼šè¯çŠ¶æ€ (sessionId, sessionStatus)
   - è®¤è¯çŠ¶æ€ (isAuthenticated, authLoading)
   - æ¨¡å¼åˆ‡æ¢ (isCodingMode, æ™®é€šæ¨¡å¼)
   - æ¶ˆæ¯åˆ—è¡¨ç®¡ç† (messages)

2. **æµå¼æ•°æ®æ¥æ”¶å’Œåˆ†å‘**
   - SSEæµæ•°æ®æ¥æ”¶ (`/api/chat/stream`, `/api/coding-agent`)
   - æµå¼å“åº”è§£æ (`handleStreamingResponse`)
   - æ¶ˆæ¯åˆ›å»ºå’Œæ›´æ–°åˆ†å‘
   - æ•°æ®æµç»“æŸå¤„ç†

3. **ç³»ç»Ÿçº§LoadingçŠ¶æ€**
   - è½®æ’­Loading (`LoadingCarousel`)
   - å…¨å±€ç­‰å¾…çŠ¶æ€ (`systemLoadingState`)
   - æ€è€ƒçŠ¶æ€ (ç”¨æˆ·è¾“å…¥åç­‰å¾…AIå“åº”)
   - ç³»ç»Ÿçº§é”™è¯¯æç¤º

4. **å·¥å…·æ‰§è¡ŒçŠ¶æ€ç®¡ç†**
   - æ´»è·ƒå·¥å…·åˆ—è¡¨ (`activeTools`)
   - å·¥å…·æ‰§è¡Œå™¨ (`toolExecutor`)
   - ä»£ç æ–‡ä»¶ç®¡ç† (`codeFiles`)
   - Codingæ¨¡å¼çŠ¶æ€æŒ‡ç¤ºå™¨

5. **é”™è¯¯å¤„ç†å’Œé‡è¯•é€»è¾‘**
   - ç³»ç»Ÿçº§é”™è¯¯å¤„ç†
   - ç½‘ç»œé‡è¿é€»è¾‘
   - Codingæ¨¡å¼ç‰¹å®šé”™è¯¯

6. **è¾“å…¥æ¡†å’Œå‘é€é€»è¾‘**
   - æ¶ˆæ¯å‘é€å‡½æ•° (`sendMessage`)
   - è¾“å…¥æ¡†çŠ¶æ€ç®¡ç†
   - æ–‡ä»¶ä¸Šä¼ å¤„ç†
   - é˜²é‡å¤æäº¤

#### ã€ä¸è´Ÿè´£ã€‘
- âŒ å•ä¸ªæ¶ˆæ¯çš„å†…å®¹æ¸²æŸ“
- âŒ æ¶ˆæ¯å†…çš„äº¤äº’è¡¨å•
- âŒ æ¶ˆæ¯çº§åˆ«çš„loadingçŠ¶æ€

---

### ğŸ’¬ **MessageBubble èŒè´£èŒƒå›´**

#### ã€æ ¸å¿ƒèŒè´£ã€‘
1. **å•ä¸ªæ¶ˆæ¯å†…å®¹æ¸²æŸ“**
   - Markdownå†…å®¹æ¸²æŸ“ (`MarkdownRenderer`)
   - ä»£ç æ–‡ä»¶å±•ç¤º (`FileCreationPanel`)
   - æ¶ˆæ¯å¤´åƒå’Œå¸ƒå±€
   - ç”¨æˆ·vsåŠ©æ‰‹æ¶ˆæ¯åŒºåˆ†

2. **æ¶ˆæ¯å†…äº¤äº’è¡¨å•**
   - äº¤äº’å…ƒç´ æ¸²æŸ“ (é€‰æ‹©ã€è¾“å…¥ã€å¤šé€‰)
   - è¡¨å•æ•°æ®ç®¡ç† (`formData`)
   - è¡¨å•æäº¤å¤„ç† (`handleInteractionSubmit`)
   - è‡ªå®šä¹‰è¾“å…¥é€‰é¡¹

3. **æ¶ˆæ¯çº§LoadingçŠ¶æ€**
   - å†…å®¹ç”Ÿæˆä¸­çŠ¶æ€
   - äº¤äº’å‡†å¤‡ä¸­çŠ¶æ€ (`isInteractionPreparing`)
   - æ€è€ƒçŠ¶æ€ (æ— å†…å®¹æ—¶æ˜¾ç¤º)
   - ç‰¹æ®Šloadingæ–‡æœ¬æ£€æµ‹

4. **ä»£ç æ–‡ä»¶åˆ›å»ºçŠ¶æ€å±•ç¤º**
   - æ–‡ä»¶åˆ›å»ºè¿›åº¦ (`fileCreationStatus`)
   - æ–‡ä»¶å®Œæˆå›è°ƒ (`handleFileCreated`)
   - æ–‡ä»¶çŠ¶æ€æ›´æ–°

5. **ç”¨æˆ·äº¤äº’æäº¤å¤„ç†**
   - äº¤äº’æµå¼å“åº”å¤„ç†
   - è¡¨å•éªŒè¯å’Œæäº¤
   - æäº¤loadingçŠ¶æ€
   - äº¤äº’é”™è¯¯å¤„ç†

#### ã€ä¸è´Ÿè´£ã€‘
- âŒ ç³»ç»Ÿçº§loadingçŠ¶æ€ (è½®æ’­ã€å…¨å±€ç­‰å¾…)
- âŒ å·¥å…·æ‰§è¡ŒçŠ¶æ€ç®¡ç†
- âŒ å…¨å±€é”™è¯¯å¤„ç†
- âŒ æµå¼æ•°æ®æ¥æ”¶ (åªå¤„ç†äº¤äº’ç›¸å…³çš„æµå¼å“åº”)

---

## ğŸ”„ **æ•°æ®æµå‘å›¾**

```mermaid
graph TD
    A[ç”¨æˆ·è¾“å…¥] --> B[ChatInterface.sendMessage]
    B --> C[APIè°ƒç”¨]
    C --> D[æµå¼å“åº”]
    D --> E[ChatInterface.handleStreamingResponse]
    E --> F[æ¶ˆæ¯åˆ›å»º/æ›´æ–°]
    F --> G[MessageBubbleæ¸²æŸ“]
    
    G --> H{æ¶ˆæ¯ç±»å‹}
    H -->|æ™®é€šæ–‡æœ¬| I[MarkdownRenderer]
    H -->|äº¤äº’è¡¨å•| J[äº¤äº’ç»„ä»¶æ¸²æŸ“]
    H -->|ä»£ç æ–‡ä»¶| K[FileCreationPanel]
    
    J --> L[ç”¨æˆ·äº¤äº’æäº¤]
    L --> M[MessageBubble.handleInteractionSubmit]
    M --> N[äº¤äº’APIè°ƒç”¨]
    N --> O[æµå¼å“åº”å¤„ç†]
    O --> P[æ–°æ¶ˆæ¯åˆ›å»º]
    P --> G
```

---

## ğŸ¯ **å„ç§UIçŠ¶æ€çš„è´Ÿè´£ç»„ä»¶**

### ğŸ’« **LoadingçŠ¶æ€åˆ†å·¥**

| Loadingç±»å‹ | è´Ÿè´£ç»„ä»¶ | å®ç°æ–¹å¼ | è§¦å‘æ¡ä»¶ |
|------------|----------|----------|----------|
| **ç³»ç»Ÿçº§è½®æ’­Loading** | ChatInterface | `LoadingCarousel` | ç³»ç»Ÿåˆå§‹åŒ–ã€å¤§å‹æ“ä½œ |
| **å…¨å±€ç­‰å¾…çŠ¶æ€** | ChatInterface | `systemLoadingState` | ä¼šè¯åˆ›å»ºã€æ¨¡å¼åˆ‡æ¢ |
| **AIè¾“å‡ºç­‰å¾…** | ChatInterface | `ThinkingLoader` | ç”¨æˆ·å‘é€æ¶ˆæ¯åç­‰å¾… |
| **æ¶ˆæ¯å†…å®¹ç”Ÿæˆä¸­** | MessageBubble | `messageLoadingState` | å•æ¡æ¶ˆæ¯æµå¼ç”Ÿæˆ |
| **äº¤äº’è¡¨å•å‡†å¤‡ä¸­** | MessageBubble | `isInteractionPreparing` | äº¤äº’å…ƒç´ åŠ è½½ |
| **è¡¨å•æäº¤ä¸­** | MessageBubble | `isSubmitting` | ç”¨æˆ·æäº¤äº¤äº’è¡¨å• |

### ğŸ”§ **å·¥å…·è°ƒç”¨UIåˆ†å·¥**

| å·¥å…·çŠ¶æ€ | è´Ÿè´£ç»„ä»¶ | æ˜¾ç¤ºä½ç½® | å®ç°æ–¹å¼ |
|----------|----------|----------|----------|
| **æ´»è·ƒå·¥å…·åˆ—è¡¨** | ChatInterface | HeaderåŒºåŸŸ | `activeTools` + Badge |
| **å·¥å…·æ‰§è¡ŒçŠ¶æ€** | ChatInterface | çŠ¶æ€æŒ‡ç¤ºå™¨ | `CodingStatusIndicator` |
| **ä»£ç æ–‡ä»¶ç®¡ç†** | ChatInterface | ä¸»é¢æ¿ | `codeFiles` çŠ¶æ€ |
| **æ–‡ä»¶åˆ›å»ºè¿›åº¦** | MessageBubble | æ¶ˆæ¯å†… | `FileCreationPanel` |
| **å·¥å…·é”™è¯¯å¤„ç†** | ChatInterface | å…¨å±€é”™è¯¯é¢æ¿ | `codingAgentError` |

### ğŸ“ **ä»£ç ç”ŸæˆUIåˆ†å·¥**

| ä»£ç ç›¸å…³UI | è´Ÿè´£ç»„ä»¶ | æ˜¾ç¤ºæ–¹å¼ | æ•°æ®æ¥æº |
|------------|----------|----------|----------|
| **ä»£ç æ–‡ä»¶åˆ—è¡¨** | ChatInterface | å…¨å±€é¢æ¿ | `codeFiles` å…¨å±€çŠ¶æ€ |
| **æ–‡ä»¶æ ‘åˆ‡æ¢** | ChatInterface | CodingModeUI | `showFileTree` çŠ¶æ€ |
| **å•æ¡æ¶ˆæ¯çš„ä»£ç ** | MessageBubble | FileCreationPanel | `message.metadata.projectFiles` |
| **ä»£ç é«˜äº®æ¸²æŸ“** | MessageBubble | MarkdownRenderer | è‡ªåŠ¨æ£€æµ‹ä»£ç å— |
| **Codingæ¨¡å¼åˆ‡æ¢** | ChatInterface | HeaderæŒ‡ç¤ºå™¨ | `isCodingMode` çŠ¶æ€ |

---

## âš¡ **æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**

### ğŸš€ **ChatInterfaceä¼˜åŒ–**
- âœ… æµå¼æ•°æ®å¤„ç†ä¼˜åŒ–
- âœ… é˜²é‡å¤æäº¤æœºåˆ¶
- âœ… ç»„ä»¶çŠ¶æ€ç¼“å­˜ (`useMemo`)
- âœ… å·¥å…·æ‰§è¡Œé˜²æŠ–å¤„ç†

### ğŸ¨ **MessageBubbleä¼˜åŒ–**
- âœ… React.memoåŒ…è£…é˜²é‡æ¸²æŸ“
- âœ… ç²¾ç¡®ä¾èµ–é¡¹ç®¡ç†
- âœ… å–æ¶ˆæµå¼æ¸²æŸ“å»¶è¿Ÿ
- âœ… äº¤äº’çŠ¶æ€å±€éƒ¨ç®¡ç†

### ğŸ“Š **æ•´ä½“æ¶æ„ä¼˜åŒ–**
- âœ… èŒè´£æ¸…æ™°åˆ†ç¦»
- âœ… æ•°æ®æµå‘æ˜ç¡®
- âœ… çŠ¶æ€ç®¡ç†å±‚çº§åŒ–
- âœ… é”™è¯¯å¤„ç†åˆ†çº§

---

## ğŸ” **æ•…éšœæ’é™¤æŒ‡å—**

### ğŸ¤– **AIè¾“å‡ºé—®é¢˜**
1. **æ— å“åº”** â†’ æ£€æŸ¥ ChatInterface.sendMessage
2. **å†…å®¹ä¸æ˜¾ç¤º** â†’ æ£€æŸ¥ MessageBubble.MarkdownRenderer
3. **æµå¼ä¸­æ–­** â†’ æ£€æŸ¥ ChatInterface.handleStreamingResponse

### ğŸ› ï¸ **å·¥å…·è°ƒç”¨é—®é¢˜**
1. **å·¥å…·ä¸æ‰§è¡Œ** â†’ æ£€æŸ¥ ChatInterface.executeActualTool
2. **çŠ¶æ€ä¸æ›´æ–°** â†’ æ£€æŸ¥ ChatInterface.activeTools
3. **æ–‡ä»¶ä¸æ˜¾ç¤º** â†’ æ£€æŸ¥ MessageBubble.FileCreationPanel

### ğŸ“‹ **äº¤äº’è¡¨å•é—®é¢˜**
1. **è¡¨å•ä¸æ˜¾ç¤º** â†’ æ£€æŸ¥ MessageBubble.showInteraction
2. **æäº¤å¤±è´¥** â†’ æ£€æŸ¥ MessageBubble.handleInteractionSubmit
3. **loadingçŠ¶æ€** â†’ æ£€æŸ¥ MessageBubble.isSubmitting

---

## ğŸ“š **å¼€å‘æŒ‡å—**

### âœ… **æ–°å¢åŠŸèƒ½æ—¶çš„åŸåˆ™**
1. **ç³»ç»Ÿçº§åŠŸèƒ½** â†’ æ”¾å…¥ ChatInterface
2. **æ¶ˆæ¯çº§åŠŸèƒ½** â†’ æ”¾å…¥ MessageBubble
3. **å…¨å±€çŠ¶æ€** â†’ ChatInterface ç®¡ç†
4. **å±€éƒ¨çŠ¶æ€** â†’ MessageBubble ç®¡ç†

### ğŸ”§ **ä¿®æ”¹ç°æœ‰åŠŸèƒ½**
1. **å…ˆç¡®å®šèŒè´£èŒƒå›´** â†’ æŸ¥çœ‹æœ¬æ–‡æ¡£
2. **ä¿®æ”¹å¯¹åº”ç»„ä»¶** â†’ ä¸è¦è·¨ç»„ä»¶ä¿®æ”¹
3. **æ›´æ–°æ•°æ®æµ** â†’ ä¿æŒå•å‘æ•°æ®æµ
4. **æµ‹è¯•è¾¹ç•Œæƒ…å†µ** â†’ ç‰¹åˆ«æ˜¯çŠ¶æ€åˆ‡æ¢ 