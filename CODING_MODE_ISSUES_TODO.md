# Coding模式待解决问题清单

## 🚨 已发现的问题

### 1. 思考消息累积显示问题 ✅ **已修复**
- **问题描述**: 思考消息（如"🤔 正在分析您的项目需求..."和"🎯 准备生成完整项目结构..."）被累积到一起显示
- **原因**: `use-chat-system-v2.ts` 中没有对 `intent: 'thinking'` 的消息进行特殊处理
- **修复方案**: 在流式更新逻辑中添加思考消息跳过逻辑
- **修复状态**: ✅ 已完成（通过 `continue` 跳过思考消息）

### 2. Coding模式对话框中AI输出包含代码问题 🔄 **待解决**
- **问题描述**: 在Coding模式下，左侧对话框中AI的回复仍包含完整的代码内容，而不是只显示纯文本解释
- **预期行为**: 
  - 左侧对话框：只显示AI的文字说明和解释
  - 右侧编辑器：显示生成的代码文件
- **可能原因**:
  - 代码分离逻辑没有正确执行
  - 流式响应中的内容模式判断有误
  - `projectFiles` 数据传递后，原始内容没有被清理

### 3. 代码分离功能验证 🔄 **待验证**
- **验证目标**: 确认代码分离功能在新的修复中正常工作
- **验证内容**:
  - 检查 `cleanCodeFromText` 函数是否被正确调用
  - 验证 `projectFiles` 数据是否正确提取到右侧编辑器
  - 确认左侧对话框内容是否清理了代码块

## 🎯 下一步计划

### Phase 1: 代码分离功能调试
1. **添加代码分离调试日志**
   - 在 `cleanCodeFromText` 函数中添加日志
   - 在消息渲染前后添加内容对比日志
   - 验证代码块检测和移除逻辑

2. **检查数据流路径**
   - 追踪从后端 `projectFiles` 到前端显示的完整数据流
   - 确认在哪个环节代码内容被保留在对话消息中

### Phase 2: 消息内容优化
1. **完善代码内容过滤**
   - 改进代码块识别算法
   - 处理内联代码和代码片段
   - 保留重要的文本说明部分

2. **UI体验优化**
   - 添加代码文件数量提示
   - 优化左侧对话内容的可读性
   - 完善右侧代码编辑器的文件切换

### Phase 3: 测试和验证
1. **功能测试**
   - 测试不同类型的代码生成请求
   - 验证思考消息不再显示
   - 确认代码分离工作正常

2. **用户体验测试**
   - 验证对话框内容简洁易读
   - 确认代码文件在编辑器中正确显示
   - 测试文件切换和编辑功能

## 📝 技术备注

### 关键文件路径
- `hooks/use-chat-system-v2.ts` - 流式响应处理逻辑
- `components/chat/MessageBubble.tsx` - 消息内容渲染
- `lib/utils.ts` - `cleanCodeFromText` 代码分离函数
- `components/chat/ChatInterface.tsx` - 主界面协调

### 重要数据结构
```typescript
// 流式响应数据格式
interface StreamableAgentResponse {
  immediate_display: {
    reply: string;
    agent_name: string;
  };
  system_state: {
    intent: 'thinking' | 'generating' | 'done';
    metadata: {
      projectFiles?: Array<{
        filename: string;
        content: string;
        language: string;
      }>;
    };
  };
}
```

### 调试命令
```bash
# 监控思考消息处理
# 在浏览器控制台查找：💭 [思考消息] 跳过思考状态

# 监控代码分离
# 在浏览器控制台查找：🎯 [代码分离] 相关日志
```

---

**最后更新**: 2025-07-25  
**状态**: 思考消息问题已修复，代码分离问题待解决 